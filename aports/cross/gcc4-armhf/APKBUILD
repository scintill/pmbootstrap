# Automatically generated aport, do not edit!
# Generator: pmbootstrap aportgen gcc-armhf
# Based on: main/gcc

CTARGET_ARCH=armhf
CTARGET="armv6-alpine-linux-gnueabihf"
CBUILDROOT="/usr/$CTARGET"
LANG_OBJC=false
LANG_JAVA=false
LANG_GO=false
LANG_FORTRAN=false
LANG_ADA=false
options="!strip !tracedeps"

# Wrap the package function, to make the resulting package
# lazy-reproducible
package() {
    # Repack the *.a files to be reproducible (see #64)
    _temp="$_builddir"/_reproducible-patch
    cd "$_builddir"
    for f in $(find -name '*.a'); do
        # Copy to a temporary folder
        echo "Repack $f to be reproducible"
        mkdir -p "$_temp"
        cd "$_temp"
        cp "$_builddir"/"$f" .

        # Repack with a sorted file order
        ar x *.a
        rm *.a
        ar r sorted.a $(find -name '*.o' | sort)

        # Copy back and clean up
        cp -v sorted.a "$_builddir"/"$f"
        cd ..
        rm -r "$_temp"
    done

    # Unmodified package function from the gcc APKBUILD
    _package

    # Workaround for: postmarketOS/binary-package-repo#1
    echo "Replacing hardlinks with symlinks"
    rm -v "$pkgdir"/usr/bin/"$CTARGET"-c++
    ln -s -v /usr/bin/"$CTARGET"-g++ "$pkgdir"/usr/bin/"$CTARGET"-c++
    rm -v "$pkgdir"/usr/bin/"$CTARGET"-gcc-"$pkgver"
    ln -s -v /usr/bin/"$CTARGET"-gcc "$pkgdir"/usr/bin/"$CTARGET"-gcc-"$pkgver"
}

pkgname="gcc4-armhf"
pkgver=4.4.4
_pv=4.4.2

pkgrel=5
pkgdesc="Stage2 cross-compiler for armhf"
url="http://gcc.gnu.org"
arch="x86_64"
license="GPL LGPL"
depends="isl binutils-armhf"
makedepends="bison flex gmp-dev mpfr-dev texinfo"
subpackages="g++-armhf:gpp"
source="ftp://gcc.gnu.org/pub/gcc/releases/gcc-$pkgver/gcc-core-$pkgver.tar.bz2
	ftp://gcc.gnu.org/pub/gcc/releases/gcc-$pkgver/gcc-g++-$pkgver.tar.bz2
	ftp://gcc.gnu.org/pub/gcc/releases/gcc-$pkgver/gcc-objc-$pkgver.tar.bz2
	gcc-spec-env.patch
	pt_gnu_eh_frame.patch
	uclibc-getipinfo.patch
	gcc-dynamic-linker.patch
	PR32219.patch
	"
#	ftp://gcc.gnu.org/pub/gcc/releases/gcc-$pkgver/gcc-objc-$pkgver.tar.bz2		   1

builddir="$srcdir"/gcc-$pkgver

build ()
{
	cd "$builddir"

	echo ${pkgver} > gcc/BASE-VER
	mkdir build
	cd build
	# https://stackoverflow.com/a/35230665
	PFX="/usr/bin/armv6-alpine-linux-muslgnueabihf-"
	export \
	CFLAGS="-fgnu89-inline" CXXFLAGS="-fgnu89-inline" \
		GCC_FOR_TARGET="${PFX}gcc" \
		CXX_FOR_TARGET="${PFX}g++" AR_FOR_TARGET="${PFX}ar" \
		AS_FOR_TARGET="${PFX}as" \
		LD_FOR_TARGET="${PFX}ld" NM_FOR_TARGET="${PFX}nm" OBJDUMP_FOR_TARGET="${PFX}objdump" \
		RANLIB_FOR_TARGET="${PFX}ranlib" STRIP_FOR_TARGET="${PFX}strip"
	../configure --prefix=/usr \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--build="x86_64-linux-gnu" \
		--host="x86_64-linux-gnu" \
		--target=${CTARGET} \
		--with-arch=armv6zk --with-tune=arm1176jzf-s --with-fpu=vfp --with-float=soft --with-abi=aapcs-linux \
		--disable-altivec \
		--disable-checking \
		--disable-fixed-point \
		--disable-libssp \
		--disable-libstdcxx-pch \
		--disable-multilib \
		--disable-nls \
		--disable-werror \
		--enable-__cxa_atexit \
		--enable-cld \
		--enable-espf \
		--enable-languages=c,c++,objc \
		--enable-shared \
		--enable-target-optspace \
		--enable-tls \
		--enable-threads \
		--with-dynamic-linker= \
		--with-dynamic-linker-prefix=/lib \
		--with-system-zlib \
		--without-system-libunwind

	# buggy/old texinfo code workaround - don't build docs
	echo MAKEINFO:= >> Makefile

	make \
		|| return 1
}

_package() {
	cd "$srcdir"/gcc-$pkgver/build
	make -j1 DESTDIR="${pkgdir}" install || return 1
	ln -s gcc "$pkgdir"/usr/bin/cc

	# binutils provides libiberty.a
	rm -f "$pkgdir"/usr/lib/libiberty.a
}

libcxx() {
	pkgdesc="GNU C++ standard runtime library"
	depends=
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libstdc++.so.* "$subpkgdir"/usr/lib/
}

gpp() {
	pkgdesc="GNU C++ standard library and compiler"
	depends="libstdc++"
	local libexec=usr/libexec/gcc/${CHOST:-$_chost}/$pkgver
	mkdir -p "$subpkgdir/$libexec" \
		"$subpkgdir"/usr/bin \
		"$subpkgdir"/usr/include \
		"$subpkgdir"/usr/lib \

	mv "$pkgdir/$libexec/cc1plus" "$subpkgdir/$libexec/"
	mv "$pkgdir"/usr/lib/*++* "$subpkgdir"/usr/lib/
	mv "$pkgdir"/usr/include/c++ "$subpkgdir"/usr/include/
	mv "$pkgdir"/usr/bin/*++ "$subpkgdir"/usr/bin/
}

objc() {
	pkgdesc="GNU ObjectiveC library"
	mkdir -p "$subpkgdir"/usr/lib

	mv "$pkgdir"/usr/lib/*objc* "$subpkgdir"/usr/lib/
}

libgcc() {
	pkgdesc="GNU C compiler runtime libraries"
	depends=
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libgcc_s.so.* "$subpkgdir"/usr/lib/
}

libgomp() {
	pkgdesc="GCC shared-memory parallel programming API library"
	depends=
	replaces="gcc"
	mkdir -p "$subpkgdir"/usr/lib
	mv "$pkgdir"/usr/lib/libgomp.so.* "$subpkgdir"/usr/lib/
}

md5sums="eb68755f64b9a4e37751992abb41c4fc  gcc-core-4.4.4.tar.bz2
d51a6ec3eac1a90e7fc280d976ce7f80  gcc-g++-4.4.4.tar.bz2
871cdd1a1ed8806a9bd5afcef0938fef  gcc-objc-4.4.4.tar.bz2
c4045bfa85d8be780affd465be9d8ca8  gcc-spec-env.patch
2db1e3482c5dd59dab70f701afa2ca80  pt_gnu_eh_frame.patch
6cc2385c5bbd6d0da6eaedd53c8bf547  uclibc-getipinfo.patch
6db5c87887beee75cde3cce86625b9ed  gcc-dynamic-linker.patch
6c866c7fb8d56deb8f6d652bee64e228  PR32219.patch"
